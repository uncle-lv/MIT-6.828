# Lab1 Booting a PC

## 概述

本次实验的主要内容是探究计算机的启动过程。计算机的启动过程是指从CPU加电到操作系统被加载到内存中计算机所进行的一系列操作。通俗地讲，就是从我们按下开机键到计算机被完全启动的这个过程。

## The PC's Physical Address Space

<br/>

>注：这里我略过了*Getting Started with x86 assembly*和*Simulating the x86*这两部分内容。第一部分是学习x86汇编语法，需要读者自己学习。第二部分是使用qemu虚拟机模拟x86环境，这一部分我们已经在[环境准备](https://github.com/uncle-lv/MIT-6.828/blob/main/0.environ-preparation.md#%E9%AA%8C%E8%AF%81%E7%8E%AF%E5%A2%83)这一章节中学习过了，不再赘述。

<br/>

通常来说，PC的物理地址空间分布如下图所示：
```
+------------------+  <- 0xFFFFFFFF (4GB)
|      32-bit      |
|  memory mapped   |
|     devices      |
|                  |
/\/\/\/\/\/\/\/\/\/\

/\/\/\/\/\/\/\/\/\/\
|                  |
|      Unused      |
|                  |
+------------------+  <- depends on amount of RAM
|                  |
|                  |
| Extended Memory  |
|                  |
|                  |
+------------------+  <- 0x00100000 (1MB)
|     BIOS ROM     |
+------------------+  <- 0x000F0000 (960KB)
|  16-bit devices, |
|  expansion ROMs  |
+------------------+  <- 0x000C0000 (768KB)
|   VGA Display    |
+------------------+  <- 0x000A0000 (640KB)
|                  |
|    Low Memory    |
|                  |
+------------------+  <- 0x00000000
```

基于Intel 8088 16位处理器的早期PC只能操作1M的物理内存。被标记为*Low Memory*的640K空间是早期PC唯一可以使用的RAM（random-access memory）。

从0x000A0000到0x000FFFFF的384KB区域是预留给硬件设备的，用做视频显示缓冲区或者保存固件等特殊用途。预留区域中最重要的部分是BIOS（Basic Input/Output System），它占据从0x000F0000到0x000FFFFF的64KB空间。在早期PC中，BIOS被保存在真正的ROM（read-only memory）中，但是如今的PC将BIOS存储在可更新的闪存中。BIOS负责基本系统的初始化，进行显卡激活和存储器安装数量检查等工作。初始化完成后，BIOS将从适当的位置加载操作系统，比如软盘、硬盘、CD-ROM、甚至是互联网，并将控制权移交给操作系统。

> “真正的ROM”听起来多少有点奇怪。从ROM的名称，我们就可以知道它应该是只读的。但是对硬件稍有了解的同学都知道如今的ROM是可以多次写入的。这实际上是一个历史遗留问题，早期的ROM确实是一次性写入、不可更改的。
> 接触过嵌入式的同学应该都听说过“烧录”一词。我在学习嵌入式时就曾有过这样一个疑惑：单片机的程序明明可以多次写入，为什么这个过程要叫“烧录”呢？老师说，以前的单片机确实只能写入一次。但随着技术的发展，后来可以多次写入了，但“烧录”一词却传承了下来。
> “ROM”一词也属于这种情况。

尽管后来的Intel处理器突破了1MB的限制，达到了16MB、甚至4GB的物理地址空间。但为了向后兼容，仍然保留了最初的1MB物理地址空间。因此，现在的PC在0x000A0000到0x00100000的物理地址空间上有一个分割*low memory*（或者*conventional memory*）区域和*extended memory*区域的“洞”。除此之外，部分位于32位PC物理地址空间顶部的区域，现在通常预留给BIOS，提供给32位的PCI设备使用。

当前的x86处理器能支持超过4GB的物理RAM，所以RAM地址已经远远超出了0xFFFFFFFF。在这种情况下，BIOS必须在RAM的32位可寻址区域顶部规划出第二个洞，为一些32位设备映射留出空间。因为设计的局限，JOS只能使用256MB的物理地址空间，所以我们假设PC只有32位的物理地址空间。但处理复杂的物理地址空间与其他硬件设备之间的组织关系已经成为了操作系统开发实践中最大的挑战之一。
